# 眼球B超图片的边缘检测及三维模型的构建

---

## 零、 前面完成的工作

目前已经完成了在二维图片下的眼球轮廓查找及提取，现在要做的工作就是将二维的坐标映射到三维空间。如下图所示，我需要做的工作就是把黄色对应的三维空间坐标确定下来。
![trace.jpg](https://raw.githubusercontent.com/taotie144/ImgStore/master/temp1/trace.jpg)

## 一、初步处理

由于在图中显示的曲线的二维坐标全部都是在大小为720×576的B超图片中的绝对坐标，而对于三维模型的构建，需要使用的是相对坐标。基本的操作方法就是，选定一个点为参考点，整条曲线的坐标全部转换为参考点的相对坐标，这样对于不同的B超图片所查找出来的边缘就有了相同的标准，能够在同一个三维模型中使用。接下来就是需要以该参考点为中心旋转一定角度，使得曲线的起点和终点位于同一列上。

![edges.jpg](https://raw.githubusercontent.com/taotie144/ImgStore/master/temp2/edges.jpg)

如上图所示，黄线围成的类似弓形的区域平移旋转后，弓形的端点与图片原点重合，弓形的直边也要与竖直的列平行。
设曲线的起点和终点分别为

<p><img src="https://latex.codecogs.com/svg.latex?P_1(x_1,y_1),&space;P_2(x_2,y_2)" title="P_1(x_1,y_1), P_2(x_2,y_2)" /></p>

那么对于曲线上任意一点P，其变换为

<p><img src="https://latex.codecogs.com/svg.latex?P(x,y)\to&space;P'(x',y')" title="P(x,y)\to P'(x',y')" /></p>
<p><img src="https://latex.codecogs.com/svg.latex?x'=\frac{(x-x_1)*(x_2-x_1)&plus;(y-y_1)*(y_2-y_1))}&space;{\sqrt{(x_2-x_1)^2&plus;(y_2-y_1)^2}}" title="x'=\frac{(x-x_1)*(x_2-x_1)+(y-y_1)*(y_2-y_1))} {\sqrt{(x_2-x_1)^2+(y_2-y_1)^2}}" /></p>
<p><img src="https://latex.codecogs.com/svg.latex?y'=\frac{(y-y_1)*(x_2-x_1)-(x-x_1)*(y_2-y_1))}&space;{\sqrt{(x_2-x_1)^2&plus;(y_2-y_1)^2}}" title="y'=\frac{(y-y_1)*(x_2-x_1)-(x-x_1)*(y_2-y_1))} {\sqrt{(x_2-x_1)^2+(y_2-y_1)^2}}" /></p>

按照以上公式，得到下图

![trace.jpg](https://raw.githubusercontent.com/taotie144/ImgStore/master/temp2/trace.jpg)

把XY坐标互换，按一般的坐标轴来显示，并且把曲线平移到中心点在X轴上

![newtrace.jpg](https://raw.githubusercontent.com/taotie144/ImgStore/master/temp2/newtrace.jpg)

那么现在得到的图像已经可以看做是一个三维图像在二维截面上的投影，下一步探讨如何投影。

## 二、三维模型构建
上次的报告提到的未解决的问题中，B超图像拍照时在三维空间中的角度无法确定，而且图中也不存在这种信息。我们就可以假设一个模型，把眼球比作，那每条曲线都相当于地球上的某一条经线的一部分，而经线在地球上的位置自然就是用经度来表示的，经度取0°到360°，即相对于本初子午线逆时针（从北极上看）旋转的角度。那么我们需要确定曲线的位置，当然也要选定一个参考平面（即子午线所在的平面），假设X-Y平面为参考平面，Z轴即垂直于参考平面，曲线所在平面与参考平面的绕Y轴的夹角θ取值[-π/2, π/2]。θ角作为输入参数，在使用多条曲线建模的时候需要分别设置每条曲线的θ值。
第二个问题就是，曲线是经线的一部分，是不包括南极点和北极点的，实际上经线就是，若把曲线看作是半圆上的一段弧，那么只要求出半圆的半径即可确定曲线的位置。半径的计算方法暂时使用的是曲线与坐标轴相交的三个点确定的圆的半径，当然也可以用平均曲率半径，这点有待讨论。那么以该直径作单位圆的同心圆，与Y轴的两个交点即南北极。

![longtitude.jpg](https://raw.githubusercontent.com/taotie144/ImgStore/master/temp2/longtitude.jpg)

如上图所示，红色的曲线与圆贴合得比较紧密，比较好地描述了曲线在切片中的位置。对于同一个眼球的一系列曲线，原理上来说这些曲线对应的半径必须是一样的，但是分别计算半径的结果肯定是不一样的，所以对于同一个眼球可以人为给定一个半径或者用其中一条曲线计算出半径后让其他的曲线都共用这个半径。

## 三、待解决问题
1. 半径的确定方法可能不准确，本来想用曲率半径来做，但是离散曲线的曲率半径不容易求，所以这里为了方便在曲线中取出三个点，用三点圆的半径来代替。
2. 最开始对B超二值化的时候，选定的阈值为70，对于目前使用的测试图片都比较适用，但是不保证任意一张图片都适用，现在想用一个新的算法根据输入的图片来决定最佳阈值。
